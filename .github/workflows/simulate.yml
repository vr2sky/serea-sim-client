name: Simulate SEREA decision

on:
  workflow_dispatch:
    inputs:
      provider:
        description: "provider: github|gitlab"
        required: true
        default: "github"
        type: choice
        options:
          - github
          - gitlab
      action:
        description: "action: deploy|release|job|..."
        required: true
        default: "deploy"
      environment:
        description: "env: dev|recette|prod"
        required: true
        default: "recette"
        type: choice
        options:
          - dev
          - recette
          - prod
      repository:
        description: "repo slug (owner/name)"
        required: false
        default: ""
      branch:
        description: "branch/ref"
        required: false
        default: ""

jobs:
  simulate:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Resolve defaults for optional inputs
        id: defaults
        shell: bash
        run: |
          set -euo pipefail

          repo_input='${{ inputs.repository }}'
          branch_input='${{ inputs.branch }}'

          if [ -z "$repo_input" ]; then
            repo_input='${{ github.repository }}'
          fi

          if [ -z "$branch_input" ]; then
            branch_input='${{ github.ref_name }}'
          fi

          {
            echo "repository=$repo_input"
            echo "branch=$branch_input"
          } >> "$GITHUB_OUTPUT"

      - name: Validate inputs (fail fast)
        shell: bash
        run: |
          set -euo pipefail
          case "${{ inputs.provider }}" in
            github|gitlab) ;;
            *) echo "Invalid provider: ${{ inputs.provider }} (allowed: github|gitlab)"; exit 2 ;;
          esac

      - name: Build payload (canonical flat DTO)
        id: payload
        shell: bash
        run: |
          set -euo pipefail

          provider='${{ inputs.provider }}'
          action='${{ inputs.action }}'
          environment='${{ inputs.environment }}'
          repository='${{ steps.defaults.outputs.repository }}'
          branch='${{ steps.defaults.outputs.branch }}'

          provider_instance="${provider}-${environment}"
          external_id="${{ github.run_id }}"
          workflow="${{ github.workflow }}"
          event_name="workflow_dispatch"

          jq -n \
            --arg provider "$provider" \
            --arg provider_instance "$provider_instance" \
            --arg external_id "$external_id" \
            --arg repository "$repository" \
            --arg branch "$branch" \
            --arg workflow "$workflow" \
            --arg event_name "$event_name" \
            --arg action "$action" \
            --arg environment "$environment" \
            '{
              provider: $provider,
              provider_instance: $provider_instance,
              external_id: $external_id,
              repository: $repository,
              branch: $branch,
              workflow: $workflow,
              event_name: $event_name,
              action: $action,
              environment: $environment
            }' > payload.json

          echo "Payload (client request):"
          cat payload.json | jq .

      - name: Call SEREA simulate endpoint
        env:
          SEREA_ACCESS_TOKEN: ${{ secrets.SEREA_ACCESS_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${SEREA_ACCESS_TOKEN:-}" ]; then
            echo "Missing secret: SEREA_ACCESS_TOKEN"
            exit 3
          fi

          URL="https://api.aquila.grinder.ovh/v5/governance/simulate"

          echo "Calling SEREA..."
          http_code="$(curl -sS -o result.json -w "%{http_code}" \
            -X POST "$URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${SEREA_ACCESS_TOKEN}" \
            --data-binary @payload.json
          )"

          echo "HTTP ${http_code}"
          echo "Result (pretty):"
          cat result.json | jq . || cat result.json

          case "${http_code}" in
            200|201|202|204) ;;
            422)
              echo "DTO validation error (expected until payload is fully aligned)."
              ;;
            *)
              echo "Non-success HTTP status: ${http_code}"
              exit 4
              ;;
          esac

      - name: Upload artifacts (payload + result)
        uses: actions/upload-artifact@v4
        with:
          name: serea-simulate
          path: |
            payload.json
            result.json
