name: Simulate SEREA decision

on:
  workflow_dispatch:
    inputs:
      provider:
        description: "provider: github|gitlab"
        required: true
        default: "github"
        type: choice
        options:
          - github
          - gitlab
      environment:
        description: "env: dev|recette|prod"
        required: true
        default: "recette"
        type: choice
        options:
          - dev
          - recette
          - prod
      repository:
        description: "repo slug (owner/name) — default: current repo"
        required: false
        default: ""
      branch:
        description: "branch/ref — default: current ref"
        required: false
        default: ""

jobs:
  simulate:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Resolve defaults for optional inputs
        id: defaults
        shell: bash
        run: |
          set -euo pipefail

          repo_input='${{ inputs.repository }}'
          branch_input='${{ inputs.branch }}'

          if [ -z "$repo_input" ]; then
            repo_input='${{ github.repository }}'
          fi

          if [ -z "$branch_input" ]; then
            branch_input='${{ github.ref_name }}'
          fi

          {
            echo "repository=$repo_input"
            echo "branch=$branch_input"
          } >> "$GITHUB_OUTPUT"

      - name: Validate inputs (fail fast)
        shell: bash
        run: |
          set -euo pipefail
          case "${{ inputs.provider }}" in
            github|gitlab) ;;
            *) echo "Invalid provider: ${{ inputs.provider }} (allowed: github|gitlab)"; exit 2 ;;
          esac

      - name: Build payload + call simulate + gate
        env:
          SEREA_ACCESS_TOKEN: ${{ secrets.SEREA_ACCESS_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          : "${GITHUB_WORKSPACE:?GITHUB_WORKSPACE is required (must run inside GitHub Actions runner)}"
          cd "$GITHUB_WORKSPACE"

          outdir="$GITHUB_WORKSPACE/out"
          mkdir -p "$outdir"

          payload="$outdir/payload.json"
          result="$outdir/result.json"

          if [ -z "${SEREA_ACCESS_TOKEN:-}" ]; then
            echo "Missing secret: SEREA_ACCESS_TOKEN"
            exit 3
          fi

          provider='${{ inputs.provider }}'
          environment='${{ inputs.environment }}'
          repository='${{ steps.defaults.outputs.repository }}'
          branch='${{ steps.defaults.outputs.branch }}'

          provider_instance="${provider}-${environment}"
          external_id='${{ github.run_id }}'
          workflow='${{ github.workflow }}'
          event_name='${{ github.event_name }}'

          jq -n \
            --arg provider "$provider" \
            --arg provider_instance "$provider_instance" \
            --arg external_id "$external_id" \
            --arg repository "$repository" \
            --arg branch "$branch" \
            --arg workflow "$workflow" \
            --arg event_name "$event_name" \
            '{
              provider: $provider,
              provider_instance: $provider_instance,
              external_id: $external_id,
              repository: $repository,
              branch: $branch,
              workflow: $workflow,
              event_name: $event_name
            }' > "$payload"

          echo "Payload:"
          jq . "$payload"

          URL="https://api.aquila.grinder.ovh/v5/governance/simulate"

          http_code="$(curl -sS -o "$result" -w "%{http_code}" \
            -X POST "$URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${SEREA_ACCESS_TOKEN}" \
            --data-binary @"$payload"
          )"

          echo "HTTP ${http_code}"
          echo "Result:"
          jq . "$result" || cat "$result"

          case "${http_code}" in
            200|201|202|204) ;;
            *) echo "Non-success HTTP status: ${http_code}"; exit 4 ;;
          esac

          decision="$(jq -r '.decision // empty' "$result")"
          reason="$(jq -r '.final_reason_code // empty' "$result")"
          decision_id="$(jq -r '.decision_id // empty' "$result")"
          inputs_digest="$(jq -r '.inputs_digest // empty' "$result")"

          echo "decision=${decision}"
          echo "final_reason_code=${reason}"
          echo "decision_id=${decision_id}"
          echo "inputs_digest=${inputs_digest}"

          if [ "${decision}" = "DENY" ]; then
            echo "Governance gate: DENY (${reason})"
            exit 10
          fi

          if [ "${decision}" != "ALLOW" ]; then
            echo "Governance gate: invalid decision value '${decision}'"
            exit 11
          fi

      - name: Upload artifacts (payload + result)
        uses: actions/upload-artifact@v4
        with:
          name: serea-simulate
          path: |
            out/payload.json
            out/result.json
